# JSP

This is a repository for running experiments on the web using jspsych library. Currently running at http://158.37.63.194/

## Table of Contents

- [Data parsing (python)](#data-parsing-python)
- [NREC server](#nrec-server)
- [Development](#development)
- [.env configuration](#env-configuration)
- [CI: Build and publish Docker images to GHCR](#ci-build-and-publish-docker-images-to-ghcr)
- [Future work](#future-work)
- [License](#license)
- [Contact](#contact)


## Data parsing (python)

Script used to parse .json data that is generated by jspsych library. Takes in a path to zipped (or unzipped) folder that contains .json files from jspsych library and saves the data to two .csv file: short version containing all results and long version with the data only from video responses

### To install:

1. Download and install [python](https://www.python.org/downloads/). Tested with Python 3.12.0
2. In console go into the `pythonDataParsing` folder and run `pip install -r requirements.txt` to install other requirements needed to run the code.

### To run:

1. Open `parse_raw_jspsych_data.py` and edit parameters at the start of the file, especially `ZIP_PATH` that takes in the path to the folder containing .json files.
2. In a console run `python parse_raw_jspsych_data.py` inside the same folder as the file.

## NREC server

Server has read-access to this repository to get the code, build and serve it. Currently, `158.37.63.194` should be running at all times.

### Access (SSH)

If it is the first time accessing the server, you need to create SSH key on your machine and add it on the NREC website, following [this](https://docs.nrec.no/ssh.html) guide. Otherwise:

1. Connect to UiO VPN
2. In the console of your choice run `ssh -i ~/.ssh/nrec ubuntu@158.37.63.194`, where `~/.ssh/nrec` is the path to the SSH key on your machine.
3. (Ignore for now) If you have set up that only logged-in users can join the server you´ll need to alternatively run `ssh -J username@login.uio.no -i ~/.ssh/nrec ubuntu@158.37.63.194`, where `username` is your UiO username.

#### Local

To host locally you can follow these steps

1. Go into the repo folder and run `git pull` to get the changes
2. Create .env file based on .env.example
3. Run `docker compose -f docker-compose.local.yml up` which will build the project locally and start it

To update this you need to run 
1. `docker compose down`
2. `git pull`
3. `docker compose -f docker-compose.local.yml up`

### Run on a server with automatic updates

In case the server needs to be set up again, otherwise feel free to ignore this section. Here are some steps in broad terms needed to achieve that:

1. Create SSH key on your machine and add it to NREC, following [this](https://docs.nrec.no/ssh.html) guide.
2. Following [this](https://docs.nrec.no/create-virtual-machine.html) create the server:
   - Choose GOLD Ubuntu 22.04 LTS
   - DUAL network protocols (UiO VPN does not create IPv6, only IPv4)
3. Set up Security Group as described [here](https://docs.nrec.no/security-groups.html#id12) with SSH and HTTPS open from all IP addresses.
4. [Access the server](#access-ssh)
5. If docker is not installed, install docker https://docs.docker.com/engine/install/ubuntu/ 
6. If you have firewall installed, make sure 80 and 443 is allowed
7. Copy docker-compose.ghcr.yml to the server
8. Create .env file similar to .env.example and add valid values
9. Run everything with this command `docker compose -f docker-compose.ghcr.yml up`, the software should automatically update when changes are published


# Development 

## Website code

Prerequisites:

- Node https://nodejs.org/en/blog/release/
- Python

### Backend

Handles server-side logic and API endpoints. It uploads experiment data JSON to OSF. Configure via root `.env` (see Configuration section). Get token from `https://osf.io/settings/tokens`; resource id is in the project URL.

### Frontend

The frontend is built using [jspsych builder](https://github.com/bjoluc/jspsych-builder).

Uses a new [video-several-keyboard-responses](https://github.com/jspsych/jspsych-contrib/tree/main/packages/plugin-video-several-keyboard-responses) plugin for the video experiment.

Run `npm run start experiment` to start running the specific js file in this case `experiment.js`, when testing. Remember to run `npm build` the first time setting up the project.


## .env configuration

Create a `.env` file at the repository root. These variables configure both local and server deployments via the compose files.

- OSF_API_TOKEN: Personal access token from OSF used by the backend to upload data. Obtain from `https://osf.io/settings/tokens`.
- OSF_RESOURCE_ID: The OSF project identifier where data should be uploaded. This is the part in the project URL after `https://osf.io/`.
- HOST_URL: The public host used by the backend for constructing absolute URLs if needed (e.g., `example.com`). Often the same as `SERVER_NAME`.
- SERVER_NAME: Domain name that Nginx/Certbot will use for TLS certificates (e.g., `example.com`). Required by the `proxy` service.
- EMAIL: Email address for Certbot registration and expiry notices. Required by the `proxy` service.
- FRONTEND_HOST: Hostname (Docker service name) of the frontend that Nginx should route to. Default: `frontend`.
- FRONTEND_PORT: Port exposed by the frontend container. Default: `80`.
- BACKEND_HOST: Hostname (Docker service name) of the backend that Nginx should route to. Default: `backend`.
- BACKEND_PORT: Port exposed by the backend container. Default: `3001`.

Example skeleton:

```env
# Backend (OSF)
OSF_API_TOKEN=
OSF_RESOURCE_ID=
HOST_URL=example.com

# Proxy / TLS
SERVER_NAME=example.com
EMAIL=admin@example.com

# Upstreams for proxy
FRONTEND_HOST=frontend
FRONTEND_PORT=8080
BACKEND_HOST=backend
BACKEND_PORT=3001
```

If your GHCR images are private, authenticate once on the host using a token with package:read before starting the stack:

```bash
echo "$GITHUB_TOKEN" | docker login ghcr.io -u <your_github_username> --password-stdin
```

## CI: Build and publish Docker images to GHCR

This repository includes a GitHub Actions workflow that builds and publishes Docker images to the GitHub Container Registry (GHCR).

- Workflow file: `.github/workflows/publish-images.yml`
- Triggers: push to `main`, any tag (e.g., `v1.2.3`), and manual dispatch
- Registry: `ghcr.io`
- Images published:
  - `ghcr.io/<owner>/psyexperiments-frontend`
  - `ghcr.io/<owner>/psyexperiments-backend`
  - `ghcr.io/<owner>/psyexperiments-proxy`
- Tags applied automatically:
  - `latest` on default branch
  - Tag ref (e.g., `v1.2.3`) on tag builds
  - Commit SHA tag on any build

### Permissions

The workflow uses the repository `GITHUB_TOKEN` to authenticate to GHCR. Ensure Actions has permission to write packages:

1. Repo settings → Actions → General → Workflow permissions: enable “Read and write permissions”.
2. If in an organization, ensure GHCR publishing is allowed for the repository.

### Using with docker-compose

If you want `docker-compose` to use the published images instead of building locally, set the `image` names to the GHCR images and remove the `build` sections (or override via an additional compose file):

```yaml
services:
  frontend:
    image: ghcr.io/<owner>/psyexperiments-frontend:latest
  backend:
    image: ghcr.io/<owner>/psyexperiments-backend:latest
  proxy:
    image: ghcr.io/<owner>/psyexperiments-proxy:latest
```

Replace `<owner>` with your GitHub username or org name.

### Configuration via root .env

Compose files read variables from a root `.env` file. Create `.env` at the repo root and fill in values. If you have `.env.example`, you can copy it as a starting point:

```bash
cp .env.example .env
```

Variables used by the stack:

- `OSF_API_TOKEN`, `OSF_RESOURCE_ID`, `HOST_URL` (backend)
- `SERVER_NAME`, `EMAIL` (proxy + certbot)
- `FRONTEND_HOST`, `FRONTEND_PORT`, `BACKEND_HOST`, `BACKEND_PORT` (proxy upstreams)

## Future work

- [ ] Implement UiO footer and header on the frontpage
- [ ] Add more safety in the `index.js` in `backend` code to check body size of requests and query length
- [ ] (Optional to make life easier) Set-up git hooks, so when there is an update, server re-builds and moves changes automatically

## License

[Insert license information here]

## Contact

For any questions or inquiries, please contact [thomasschubert](https://github.com/thomasschubert).
